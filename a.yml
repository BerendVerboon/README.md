---
- hosts: localhost
  connection: local #
  become: yes
  vars:
    target_user: "{{ lookup('env', 'TARGET_USER') | default('john', false) }}"

  tasks:
    - name: Debug .xinitrc destination path
      debug:
        msg: "/home/{{ target_user }}/.xinitrc"

    - name: Update all packages to the latest version
      pacman:
        update_cache: yes
        upgrade: yes

    - name: Install necessary packages
      pacman:
        name:
          - xorg
          - bspwm
          - sxhkd
          - xorg-xinit
          - xterm
          - feh
          - xorg-xauth
          - polybar
          - xf86-input-libinput
          - alsa-utils
          - lm_sensors
          - sysstat
          - virt-manager
          - qemu
          - libvirt
          - virt-install
          - zsh
          - kitty
        state: present

    - name: Enable and start the libvirtd service
      systemd:
        name: libvirtd
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Set zsh as the default shell for the target user
      user:
        name: "{{ target_user }}"
        shell: /bin/zsh

    - name: Check if Oh My Zsh is already installed
      stat:
        path: "/home/{{ target_user }}/.oh-my-zsh"
      register: ohmyzsh_installed
      become_user: "{{ target_user }}"  # Check as the target user

    - name: Install Oh My Zsh for the target user
      when: not ohmyzsh_installed.stat.exists  # Run only if Oh My Zsh isn't installed
      become_user: "{{ target_user }}"  # become the target user for this task
      shell: |
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
      args:
        executable: /bin/bash  # ensure we're running the command with bash
      environment:  # setting environment variables
        RUNZSH: 'no'  # prevent automatic running of zsh after installation
        CHSH: 'no'  # prevent changing the default shell, since it's already been set to zsh
        ZSH: "/home/{{ target_user }}/.oh-my-zsh"  # Oh My Zsh installation directory
      register: ohmyzsh_install  # register the output for debugging
      changed_when: true  # If the task is run, we can assume a change should be marked
      async: 60  # run the task asynchronously with a timeout of 60s
      poll: 10  # check the status every 10 seconds


    - name: Set timezone to Amsterdam
      timezone:
        name: Europe/Amsterdam

    - name: Ensure home directory permissions are correct
      file:
        path: "/home/{{ target_user }}"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Ensure .Xauthority file exists
      file:
        path: "/home/{{ target_user }}/.Xauthority"
        state: touch
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0600'

    - name: Add user to video group
      user:
        name: "{{ target_user }}"
        groups: video
        append: yes

    - name: Add user to input group
      user:
        name: "{{ target_user }}"
        groups: input
        append: yes

    - name: Ensure .config directory exists for user
      file:
        path: "/home/{{ target_user }}/.config"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Create kitty config directory
      file:
        path: "/home/{{ target_user }}/.config/kitty"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Create bspwm config directory
      file:
        path: "/home/{{ target_user }}/.config/bspwm"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Create sxhkd config directory
      file:
        path: "/home/{{ target_user }}/.config/sxhkd"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Configure kitty with Gruvbox Material Colorscheme
      copy:
        dest: "/home/{{ target_user }}/.config/kitty/kitty.conf"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0644'
        content: 
        #: Cursor customization {{{

        #: Default cursor color

        # cursor_shape block

        #: The cursor shape can be one of (block, beam, underline)

        cursor_blink_interval      0
        # cursor_stop_blinking_after 15.0

        #: The interval (in seconds) at which to blink the cursor. Set to zero
        #: to disable blinking. Note that numbers smaller than repaint_delay
        #: will be limited to repaint_delay. Stop blinking cursor after the
        #: specified number of seconds of keyboard inactivity. Set to zero to
        #: never stop blinking.

        #: }}}

        #: Scrollback {{{

        # scrollback_lines 2000

        #: Number of lines of history to keep in memory for scrolling back.
        #: Memory is allocated on demand.

        # scrollback_pager less --chop-long-lines --RAW-CONTROL-CHARS +INPUT_LINE_NUMBER

        #: Program with which to view scrollback in a new window. The
        #: scrollback buffer is passed as STDIN to this program. If you change
        #: it, make sure the program you use can handle ANSI escape sequences
        #: for colors and text formatting. INPUT_LINE_NUMBER in the command
        #: line above will be replaced by an integer representing which line
        #: should be at the top of the screen.

        # wheel_scroll_multiplier 5

        #: Modify the amount scrolled by the mouse wheel or touchpad. Use
        #: negative numbers to change scroll direction.

        #: }}}

        #: Mouse {{{

        # url_color #0087BD
        # url_style curly

        #: The color and style for highlighting URLs on mouse-over. url_style
        #: can be one of: none, single, double, curly

        # open_url_modifiers kitty_mod

        #: The modifier keys to press when clicking with the mouse on URLs to
        #: open the URL

        # open_url_with default

        #: The program with which to open URLs that are clicked on. The
        #: special value default means to use the operating system's default
        #: URL handler.

        # copy_on_select no

        #: Copy to clipboard on select. With this enabled, simply selecting
        #: text with the mouse will cause the text to be copied to clipboard.
        #: Useful on platforms such as macOS/Wayland that do not have the
        #: concept of primary selections. Note that this is a security risk,
        #: as all programs, including websites open in your browser can read
        #: the contents of the clipboard.

        # rectangle_select_modifiers ctrl+alt

        #: The modifiers to use rectangular selection (i.e. to select text in
        #: a rectangular block with the mouse)

        # select_by_word_characters :@-./_~?&=%+#

        #: Characters considered part of a word when double clicking. In
        #: addition to these characters any character that is marked as an
        #: alpha-numeric character in the unicode database will be matched.

        # click_interval 0.5

        #: The interval between successive clicks to detect double/triple
        #: clicks (in seconds)

        # mouse_hide_wait 3.0

        #: Hide mouse cursor after the specified number of seconds of the
        #: mouse not being used. Set to zero to disable mouse cursor hiding.

        # focus_follows_mouse no

        #: Set the active window to the window under the mouse when moving the
        #: mouse around

        #: }}}

        #: Window layout {{{

        # remember_window_size  yes
        # initial_window_width  640
        # initial_window_height 400

        remember_window_size no
        initial_window_width 700
        initial_window_height 500

        #: If enabled, the window size will be remembered so that new
        #: instances of kitty will have the same size as the previous
        #: instance. If disabled, the window will initially have size
        #: configured by initial_window_width/height, in pixels. You can use a
        #: suffix of "c" on the width/height values to have them interpreted
        #: as number of cells instead of pixels.

        enabled_layouts *

        #: The enabled window layouts. A comma separated list of layout names.
        #: The special value * means all layouts. The first listed layout will
        #: be used as the startup layout. For a list of available layouts, see
        #: the layouts.

        # window_resize_step_cells 2
        # window_resize_step_lines 2

        #: The step size (in units of cell width/cell height) to use when
        #: resizing windows. The cells value is used for horizontal resizing
        #: and the lines value for vertical resizing.

        window_border_width 1

        #: The width (in pts) of window borders. Will be rounded to the
        #: nearest number of pixels based on screen resolution. Note that
        #: borders are displayed only when more than one window is visible.
        #: They are meant to separate multiple windows.

        window_margin_width 0

        #: The window margin (in pts) (blank area outside the border)

        # single_window_margin_width -1000.0

        #: The window margin (in pts) to use when only a single window is
        #: visible. Negative values will cause the value of
        #: window_margin_width to be used instead.

        window_padding_width 14

        #: The window padding (in pts) (blank area between the text and the
        #: window border)

        active_border_color #282c34

        #: The color for the border of the active window

        inactive_border_color #22262d

        #: The color for the border of inactive windows

        # bell_border_color #ff5a00

        #: The color for the border of inactive windows in which a bell has
        #: occurred

        inactive_text_alpha 1.0

        #: Fade the text in inactive windows by the specified amount (a number
        #: between zero and one, with zero being fully faded).

        #: }}}

        #: Tab bar {{{

        # tab_bar_edge bottom

        #: Which edge to show the tab bar on, top or bottom

        tab_bar_margin_width 4

        #: The margin to the left and right of the tab bar (in pts)

        tab_bar_style fade

        #: The tab bar style, can be one of: fade or separator. In the fade
        #: style, each tab's edges fade into the background color, in the
        #: separator style, tabs are separated by a configurable separator.

        # tab_fade 0.25 0.5 0.75 1
        tab_fade 1 1 1

        #: Control how each tab fades into the background when using fade for
        #: the tab_bar_style. Each number is an alpha (between zero and one)
        #: that controls how much the corresponding cell fades into the
        #: background, with zero being no fade and one being full fade. You
        #: can change the number of cells used by adding/removing entries to
        #: this list.

        # tab_separator "  "


        #: Tab bar colors and styles

        #: }}}

        # braille characters
        symbol_map U+2800-U+28FF Symbola

        # Tab management
        map ctrl+tab            next_tab
        map ctrl+shift+tab      previous_tab
        #map ctrl+t              new_tab zsh
        map ctrl+shift+t        new_tab zsh
        map ctrl+shift+r        new_tab zsh -c 'ranger ~'
        map ctrl+shift+w        close_tab
        map ctrl+shift+l        next_layout
        map ctrl+shift+f        move_tab_forward
        map ctrl+shift+b        move_tab_backward
        # Just as with new_window above, you can also pass the name of arbitrary
        # commands to run when using new_tab.

        # Miscellaneous
        map ctrl+plus               increase_font_size
        map ctrl+minus              decrease_font_size
        map ctrl+shift+backspace    restore_font_size
        map ctrl+shift+f11          toggle_fullscreen

        map alt+y copy_to_clipboard
        map ctrl+p paste_from_clipboard
        map alt+p paste_from_clipboard
        map ALT+v pipe @screen window nvim -Rmn

        include colorscheme.conf

        # Disable audio bell
        enable_audio_bell no


    - name: Configure kitty with Gruvbox Material Colorscheme
      copy:
        dest: "/home/{{ target_user }}/.config/kitty/colorscheme.conf"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0644'
        content: 
            background #282828
            foreground #d4be98

            selection_background #d4be98
            selection_foreground #282828

            cursor #a89984
            cursor_text_color background

            active_tab_background #1d2021
            active_tab_foreground #a9b665
            active_tab_font_style bold
            inactive_tab_background #282828
            inactive_tab_foreground #a89984
            inactive_tab_font_style normal

            # Black
            color0      #665c54
            color8      #928374

            # Red
            color1      #ea6962
            color9      #ea6962

            # Green
            color2      #a9b665
            color10     #a9b665

            # Yellow
            color3      #e78a4e
            color11     #d8a657

            # Blue
            color4      #7daea3
            color12     #7daea3

            # Magenta
            color5      #d3869b
            color13     #d3869b

            # Cyan
            color6      #89b482
            color14     #89b482

            # White
            color7      #d4be98
            color15     #d4be98


            #: Fonts {{{

            #: kitty has very powerful font management. You can configure
            #: individual font faces and even specify special fonts for particular
            #: characters.

            font_family      monospace
            bold_font        auto
            italic_font      auto
            bold_italic_font auto

            font_family        Hack Nerd Font  
            bold_font          Hack Nerd Font 
            italic_font        Hack Nerd Font 
            bold_italic_font   Hack Nerd Font 

            #: You can specify different fonts for the bold/italic/bold-italic
            #: variants. By default they are derived automatically, by the OSes
            #: font system. Setting them manually is useful for font families that
            #: have many weight variants like Book, Medium, Thick, etc. For
            #: example::

            #:     font_family      SauceCodePro Nerd Font Mono
            #:     bold_font        Operator Mono Medium
            #:     italic_font      Operator Mono Book Italic
            #:     bold_italic_font Operator Mono Medium Italic

            font_size 11

            #: Font size (in pts)

            # adjust_line_height  0
            # adjust_column_width 0

            #: Change the size of each character cell kitty renders. You can use
            #: either numbers, which are interpreted as pixels or percentages
            #: (number followed by %), which are interpreted as percentages of the
            #: unmodified values. You can use negative pixels or percentages less
            #: than 100% to reduce sizes (but this might cause rendering
            #: artifacts).


            #background_opacity 0.95

         

    - name: Configure sxhkd hotkeys for workspace switching
      lineinfile:
        path: "/home/{{ target_user }}/.config/sxhkd/sxhkdrc"
        insertafter: EOF
        line: |
          # Workspace switching
          super + {1-9,0}
              bspc desktop -f '^{1-9,10}'
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0644'

    - name: Copy bspwm configuration
      copy:
        dest: "/home/{{ target_user }}/.config/bspwm/bspwmrc"
        content: |
          #!/bin/sh
          bspc monitor -d I II III IV V VI VII VIII IX X
          bspc config border_width 2
          bspc config window_gap 12
          bspc config split_ratio 0.52
          bspc config borderless_monocle true
          bspc config gapless_monocle true
          bspc rule -a Gimp desktop='^8' state=floating           follow=on
          bspc rule -a Chromium desktop='^2'
          bspc rule -a mplayer2 state=floating
          bspc rule -a Kupfer.py focus=on
          bspc rule -a Screenkey manage=off
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Ensure .config/bspwm directory exists
      file:
        path: "/home/{{ target_user }}/.config/bspwm"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Start virt-manager on workspace 1 on bspwm
      blockinfile:
        path: "/home/{{ target_user }}/.config/bspwm/bspwmrc"
        block: |
          # Launch virt-manager on workspace 1
          bspc rule -a virt-manager-desktop desk='^1' follow=on
          virt-manager &
        marker: "# {mark} ANSIBLE MANAGED BLOCK FOR VIRT-MANAGER"
        create: yes
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Ensure polybar config directory exists
      file:
        path: "/home/{{ target_user }}/.config/polybar"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Copy polybar configuration
      copy:
        dest: "/home/{{ target_user }}/.config/polybar/config"
        content: |
          [bar/example]
          width = 100%
          height = 24
          radius = 0
          fixed-center = false
          
          background = #222
          foreground = #fff
          
          line-size = 3
          line-color = #f00

          border-size = 0
          border-color = #00000000  
          
          padding-left = 0
          padding-right = 2

          module-margin-left = 1
          module-margin-right = 2
        
          font-0 = "xos4 Terminus:size=10;1"
          font-1 = "siji:pixelsize=10;1"
          
          modules-left = bspwm
          modules-center = cpu memory disk lan
          modules-right = pulseaudio myclock

          [module/bspwm]
          type = internal/bspwm
          ; Additional configurations for bspwm module here.

          [module/myclock]
          type = internal/date
          interval = 1.0

          date = "%Y-%m-%d"
          time = "%H:%M:%S"

          format-prefix = " "
          format-prefix-foreground = #555
          format-foreground = #fff
          format-background = #222

          label = %date% %time%

          ; CPU usage module
          [module/cpu]
          type = internal/cpu
          format = <label> <ramp-coreload>
          label = " | CPU %percentage%%"
          ramp-coreload-spacing = 1
          ramp-coreload-0 = %{F#0a0}▁%{F-}
          ramp-coreload-1 = %{F#0a0}▂%{F-}
          ramp-coreload-2 = %{F#0a0}▃%{F-}
          ramp-coreload-3 = %{F#0a0}▄%{F-}
          ramp-coreload-4 = %{F#f80}▅%{F-}
          ramp-coreload-5 = %{F#f80}▆%{F-}
          ramp-coreload-6 = %{F#f00}▇%{F-}
          ramp-coreload-7 = %{F#f00}█%{F-}

          ; Memory usage module
          [module/memory]
          type = internal/memory
          interval = 2.0
          label = MEM %percentage_used%%

          ; Disk usage module
          [module/disk]
          type = internal/fs
          interval = 30
          mount-0 = /
          label-mounted =  %free%

          [module/lan]
          type = internal/network
          interface = enp0s3
          label-connected = "%ifname%: %local_ip% |"
          label-disconnected = "%ifname%: not connected |"

          ; Volume module (requires `alsa-utils`)
          [module/pulseaudio]
          type = internal/pulseaudio
          format-volume = <label-volume> <bar-volume>
          label-volume = VOL %percentage%%
          label-volume-foreground = #a1b56c  ; volume color
          label-muted = VOL MUTED
          label-muted-foreground = #ab4642  ; muted color
          bar-volume-width = 10
          bar-volume-foreground-0 = #a1b56c  ; volume level - gradient start
          bar-volume-foreground-1 = #b8db81  ; volume level - gradient end
          bar-volume-indicator = |
          bar-volume-fill = -
          bar-volume-empty = -
          bar-volume-empty-foreground = #343d46  ; volume empty color
          bar-volume-gradient = false

          ; Further module configurations as needed...
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0644'

    - name: Copy .xinitrc file to user's home directory
      copy:
        dest: "/home/{{ target_user }}/.xinitrc"
        content: |
          #!/bin/sh
          # Set up an environment variable, if needed
          export SOME_VARIABLE="value"

          # Start some background applications
          xsetroot -solid grey &  # Set a solid grey background
          xrdb -merge ~/.Xresources &  # Load X resources (like terminal colors, fonts, etc.)

          # Set the background image using feh
          feh --bg-scale /home/{{ target_user }}/readme.md/background.jpg &

          # Launch polybar
          polybar example &

          # Start the window manager or desktop environment
          exec bspwm
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

# End of playbook
